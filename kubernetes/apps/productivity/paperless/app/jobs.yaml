apiVersion: batch/v1
kind: CronJob
metadata:
  name: paperless-cronjob-fix-tags
spec:
  schedule: "*/15 * * * *" # Every 15 minutes
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 60
      template:
        spec:
          containers:
            - name: paperless-fix-tags
              image: alpine/curl:8.12.1
              envFrom:
                - secretRef:
                    name: paperless-secret
              command:
                - sh
                - -c
                - |
                  echo "üîç Installing jq..."
                  apk add --no-cache jq > /dev/null 2>&1

                  echo "üîç Starting Paperless tag permissions fix..."
                  PAPERLESS_URL="http://paperless-paperless-ngx.productivity.svc.cluster.local"
                  GROUP_ID=3  # Group ID for tag assignment

                  echo "üîç Fetching tags from Paperless-ngx API..."
                  echo "üîç Using API Token: ${PAPERLESS_API_TOKEN:0:4}******** (Masked for Security)"

                  # Fetch tags correctly with headers
                  API_RESPONSE=$(curl -s -H "Authorization: Token $PAPERLESS_API_TOKEN" -H "Content-Type: application/json" "$PAPERLESS_URL/api/tags/")

                  echo "üîç API Response: $API_RESPONSE"

                  # Extract tag IDs safely
                  NEW_TAGS=$(echo "$API_RESPONSE" | jq -r '.results[]? | select(.ownership != "group") | .id')

                  # If no new tags are found, exit
                  if [ -z "$NEW_TAGS" ]; then
                    echo "‚úÖ No new tags found, exiting."
                    exit 0
                  fi

                  # Assign new tags to the group
                  for TAG_ID in $NEW_TAGS; do
                      echo "üîÑ Updating permissions for tag $TAG_ID..."
                      curl -X PATCH -H "Authorization: Token $PAPERLESS_API_TOKEN" -H "Content-Type: application/json" "$PAPERLESS_URL/api/tags/$TAG_ID/" -d "{\"ownership\": \"group\", \"group\": $GROUP_ID}"
                  done

                  echo "‚úÖ Tag permissions updated successfully!"
          restartPolicy: OnFailure
