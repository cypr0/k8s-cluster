apiVersion: batch/v1
kind: CronJob
metadata:
  name: paperless-cronjob-fix-ownership
spec:
  schedule: "*/15 * * * *" # Every 15 minutes
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 60
      template:
        spec:
          containers:
            - name: paperless-fix-ownership
              image: alpine/curl:8.12.1
              envFrom:
                - secretRef:
                    name: paperless-secret
              command:
                - sh
                - -c
                - |
                  echo "üîç Installing jq..."
                  apk add --no-cache jq > /dev/null 2>&1

                  echo "üîç Starting Paperless tag and correspondent permissions fix..."
                  PAPERLESS_URL="http://paperless-paperless-ngx.productivity.svc.cluster.local"
                  GROUP_ID=3  # Group ID for assignment
                  AUTH_HEADER="Authorization: Token $PAPERLESS_API_TOKEN"

                  # Function to update ownership and permissions for an item (tag or correspondent)
                  update_permissions() {
                      ITEM_TYPE=$1  # Either "tags" or "correspondents"
                      echo "üîç Checking for new $ITEM_TYPE..."

                      # Fetch items that are owned by the API user but not yet assigned to the group
                      NEW_ITEMS=$(curl -s -H "$AUTH_HEADER" -H "Content-Type: application/json" "$PAPERLESS_URL/api/$ITEM_TYPE/" | jq -r '.results[] | select(.ownership != "group") | .id')

                      if [ -z "$NEW_ITEMS" ]; then
                          echo "‚úÖ No new $ITEM_TYPE found, exiting."
                          return
                      fi

                    # Assign new items to the group and set group permissions
                    for ITEM_ID in $NEW_ITEMS; do
                        echo "üîÑ Updating permissions for $ITEM_TYPE ID $ITEM_ID..."

                        RESPONSE=$(curl -s -o response.json -w "%{http_code}" -X PATCH -H "$AUTH_HEADER" -H "Content-Type: application/json" \
                          "$PAPERLESS_URL/api/$ITEM_TYPE/$ITEM_ID/" -d "{
                            \"owner\": null,
                            \"set_permissions\": {
                                \"view\": {\"groups\": [$GROUP_ID]},
                                \"change\": {\"groups\": [$GROUP_ID]}
                            }
                          }")

                        if [ "$RESPONSE" -ne 200 ]; then
                            echo "‚ùå Error updating $ITEM_TYPE ID $ITEM_ID! HTTP Status: $RESPONSE"
                            cat response.json
                        else
                            echo "‚úÖ Successfully updated $ITEM_TYPE ID $ITEM_ID"
                        fi
                    done

                      echo "‚úÖ $ITEM_TYPE permissions updated successfully!"
                  }

                  # Fix permissions for both tags and correspondents
                  update_permissions "tags"
                  update_permissions "correspondents"

                  echo "‚úÖ Paperless permissions fix completed!"
          restartPolicy: OnFailure
